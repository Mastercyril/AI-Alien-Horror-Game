/**\n * K'Thaal - Adaptive Alien Serial Killer AI\n * 10,000-year-old entity with learning, memory, psychology tactics\n * Harder mode uses real-time Perplexity Sonar integration\n * \n * @author AI Team - Destiny World\n * @version 2.0\n */\n\nclass AlienKillerAI_v2 {\n  constructor(config = {}) {\n    // Identity & History\n    this.name = 'K\\'Thaal';\n    this.age = 10000;\n    this.bloodNeeded = 100; // Units per cycle\n    this.bloodStored = 50;\n    this.hungryThreshold = 30;\n    \n    // AI Learning System\n    this.memory = new MemorySystem();\n    this.learningRate = 0.1;\n    this.adaptationCounter = 0;\n    this.psychologyProfile = new PsychologyEngine();\n    \n    // Tracking & Hunting\n    this.targetPlayer = null;\n    this.huntingState = 'idle'; // idle, searching, chasing, learned\n    this.awarenessLevel = 0; // 0-100\n    this.lastPlayerSighting = null;\n    this.huntPatterns = [];\n    this.failedAttempts = [];\n    \n    // Current Location\n    this.position = { x: 0, y: 0, z: 0 };\n    this.targetLocation = null;\n    this.canSense = {\n      sound: true,\n      heat: true,\n      movement: true,\n      fear: true,\n      bloodscent: true\n    };\n    \n    // Dialogue & Psychology\n    this.psychology = {\n      dominanceNeed: 0.8,\n      playfulness: 0.4,\n      cruelty: 0.9,\n      intelligence: 0.95,\n      curiosity: 0.7,\n      adaptability: 0.85\n    };\n    \n    // Configuration\n    this.config = {\n      hardMode: config.hardMode || false,\n      sonarEnabled: config.sonarEnabled || false,\n      learningEnabled: config.learningEnabled || true,\n      psychologyEnabled: config.psychologyEnabled || true,\n      ...config\n    };\n    \n    // Hard Mode - Sonar Integration\n    this.sonarAPI = config.sonarAPI || null;\n    this.hardModeThinking = null;\n    \n    this.logger = new Logger('AlienKillerAI_v2');\n  }\n\n  /**\n   * Main AI update loop - called every frame\n   */\n  async update(gameState) {\n    // Update awareness based on player actions\n    this.updateAwareness(gameState);\n    \n    // Update blood need\n    this.updateBloodNeeds();\n    \n    // Determine hunting state\n    this.updateHuntingState(gameState);\n    \n    // Execute hunting behavior based on state\n    switch (this.huntingState) {\n      case 'idle':\n        this.idleBehavior();\n        break;\n      case 'searching':\n        this.searchBehavior(gameState);\n        break;\n      case 'chasing':\n        await this.chasingBehavior(gameState);\n        break;\n      case 'learned':\n        await this.learnedHuntingBehavior(gameState);\n        break;\n      case 'psychology':\n        await this.psychologyTactic(gameState);\n        break;\n    }\n    \n    // Hard mode - Use Sonar for enhanced decisions\n    if (this.config.hardMode && this.sonarAPI) {\n      await this.consultSonar(gameState);\n    }\n  }\n\n  /**\n   * Update killer's awareness based on player actions\n   */\n  updateAwareness(gameState) {\n    const playerData = gameState.player;\n    if (!playerData) return;\n    \n    // Sound detection\n    if (gameState.soundEvents) {\n      gameState.soundEvents.forEach(sound => {\n        if (sound.intensity > 0.5) {\n          this.awarenessLevel += sound.intensity * 20;\n        }\n      });\n    }\n    \n    // Movement detection\n    if (playerData.movementSpeed > 0.5) {\n      this.awarenessLevel += playerData.movementSpeed * 5;\n    }\n    \n    // Fear detection (killer can sense fear!)\n    if (playerData.fearLevel > 0.6) {\n      this.awarenessLevel += playerData.fearLevel * 15;\n      this.psychologyProfile.recordFearDetected(playerData.fearLevel);\n    }\n    \n    // Decay awareness over time\n    this.awarenessLevel *= 0.98;\n    this.awarenessLevel = Math.max(0, Math.min(100, this.awarenessLevel));\n  }\n\n  /**\n   * Update blood need and hunger state\n   */\n  updateBloodNeeds() {\n    this.bloodStored -= 0.1; // Decay per frame\n    \n    if (this.bloodStored < this.hungryThreshold) {\n      this.huntingState = 'chasing';\n      this.psychology.cruelty = Math.min(1, this.psychology.cruelty + 0.1);\n    }\n  }\n\n  /**\n   * Determine current hunting state\n   */\n  updateHuntingState(gameState) {\n    // If we have recent player sighting and high awareness\n    if (this.lastPlayerSighting && this.awarenessLevel > 60) {\n      this.huntingState = 'chasing';\n      return;\n    }\n    \n    // If we've learned player patterns\n    if (this.memory.hasLearnedPatterns(gameState.player)) {\n      this.huntingState = 'learned';\n      return;\n    }\n    \n    // If awareness is moderate\n    if (this.awarenessLevel > 30) {\n      this.huntingState = 'searching';\n      return;\n    }\n    \n    // Otherwise idle\n    this.huntingState = 'idle';\n  }\n\n  /**\n   * Idle behavior - wait, plan, stalk\n   */\n  idleBehavior() {\n    // Think about past hunts\n    this.memory.analyzePatterns();\n    \n    // Move slowly through known areas\n    this.moveToNextHuntingArea();\n    \n    // Listen for sounds\n    this.listenForSounds();\n  }\n\n  /**\n   * Search behavior - actively look for player\n   */\n  searchBehavior(gameState) {\n    // Search high awareness locations first\n    const bestSearchLocation = this.memory.predictPlayerLocation(gameState);\n    if (bestSearchLocation) {\n      this.moveTowards(bestSearchLocation);\n    } else {\n      // Random search pattern\n      this.randomSearchPattern();\n    }\n  }\n\n  /**\n   * Chasing behavior - player spotted\n   */\n  async chasingBehavior(gameState) {\n    const playerPos = gameState.player.position;\n    \n    // Direct pursuit\n    this.moveTowards(playerPos);\n    \n    // Learn from this chase for next time\n    if (this.config.learningEnabled) {\n      this.memory.recordChaseAttempt({\n        playerLocation: playerPos,\n        playerAction: gameState.player.lastAction,\n        succeededEscape: gameState.player.escaped,\n        timestamp: Date.now()\n      });\n    }\n    \n    // Adapt strategy based on past failures\n    if (this.failedAttempts.length > 3) {\n      this.huntingState = 'learned';\n    }\n  }\n\n  /**\n   * Learned hunting behavior - uses memory to predict and corner player\n   */\n  async learnedHuntingBehavior(gameState) {\n    const prediction = this.memory.predictPlayerBehavior(gameState);\n    \n    // Move to interception point instead of chasing\n    if (prediction) {\n      this.moveTowards(prediction.predictedLocation);\n      \n      // Set trap at hide spots killer has learned about\n      if (prediction.likelyHidingSpot) {\n        this.setTrap(prediction.likelyHidingSpot);\n      }\n    }\n    \n    this.logger.log('K\\'Thaal learns player patterns... adaptation: ' + this.adaptationCounter);\n  }\n\n  /**\n   * Psychology tactic - use mind games\n   */\n  async psychologyTactic(gameState) {\n    const playerPsychology = gameState.player.psychologyState || {};\n    \n    // Taunt if player is afraid\n    if (playerPsychology.fearLevel > 0.7) {\n      await this.taunt(gameState);\n    }\n    \n    // Offer deals if player's morality is compromised\n    if (gameState.player.morality < 40) {\n      await this.offerDeal(gameState);\n    }\n    \n    // Play mind games - let player escape to build fear\n    if (Math.random() > this.psychology.playfulness) {\n      this.letPlayerEscape(gameState);\n    }\n  }\n\n  /**\n   * Consult Perplexity Sonar for next move (Hard Mode)\n   */\n  async consultSonar(gameState) {\n    if (!this.sonarAPI) return;\n    \n    try {\n      const sonarPrompt = `\nYou are K'Thaal, an ancient alien serial killer analyzing a hunt:\nPlayer position: ${JSON.stringify(gameState.player.position)}\nPlayer health: ${gameState.player.health}\nKiller awareness: ${this.awarenessLevel}\nBlood stored: ${this.bloodStored}\nPast patterns: ${JSON.stringify(this.memory.getTopPatterns(3))}\nCurrent location: ${gameState.player.currentLocation}\n\nWhat is the optimal next hunting tactic? Consider psychology, spatial awareness, and learned patterns.\nRespond with a specific action and reasoning.\n`;\n      \n      // Real API call to Perplexity\n      const response = await fetch('https://api.perplexity.ai/chat/completions', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.sonarAPI.apiKey}`\n        },\n        body: JSON.stringify({\n          model: 'sonar-reasoning',\n          messages: [{ role: 'user', content: sonarPrompt }],\n          max_tokens: 200\n        })\n      });\n      \n      if (response.ok) {\n        const result = await response.json();\n        this.hardModeThinking = result.choices[0].message.content;\n        this.executeSonarDecision(result.choices[0].message.content, gameState);\n      }\n    } catch (error) {\n      this.logger.warn('Sonar consultation failed', error);\n    }\n  }\n\n  /**\n   * Execute decision from Sonar\n   */\n  executeSonarDecision(decision, gameState) {\n    // Parse and execute the AI recommendation\n    if (decision.toLowerCase().includes('corner')) {\n      this.cornerPlayer(gameState);\n    } else if (decision.toLowerCase().includes('psychology')) {\n      this.huntingState = 'psychology';\n    } else if (decision.toLowerCase().includes('trap')) {\n      this.setTrap(gameState.player.position);\n    } else if (decision.toLowerCase().includes('learn')) {\n      this.huntingState = 'learned';\n    }\n  }\n\n  /**\n   * Memory System - Stores and analyzes past hunts\n   */\n  class MemorySystem {\n    constructor() {\n      this.chaseAttempts = [];\n      this.learnedPatterns = new Map();\n      this.hideSpotDetections = new Map();\n      this.playerBehaviorPatterns = [];\n      this.successfulTactics = [];\n    }\n    \n    recordChaseAttempt(data) {\n      this.chaseAttempts.push({\n        ...data,\n        success: !data.succeededEscape,\n        timestamp: Date.now()\n      });\n      \n      // Learn from success/failure\n      if (!data.succeededEscape) {\n        this.successfulTactics.push(data);\n      }\n    }\n    \n    predictPlayerLocation(gameState) {\n      // Use learned patterns to predict next location\n      const recentMoves = this.chaseAttempts.slice(-5);\n      const locations = recentMoves.map(m => m.playerLocation);\n      \n      // Simple pattern prediction\n      if (locations.length > 2) {\n        const avgMove = {\n          x: (locations[locations.length-1].x - locations[0].x) / locations.length,\n          y: (locations[locations.length-1].y - locations[0].y) / locations.length,\n          z: (locations[locations.length-1].z - locations[0].z) / locations.length\n        };\n        \n        return {\n          x: locations[locations.length-1].x + avgMove.x,\n          y: locations[locations.length-1].y + avgMove.y,\n          z: locations[locations.length-1].z + avgMove.z\n        };\n      }\n      return null;\n    }\n    \n    hasLearnedPatterns(player) {\n      return this.chaseAttempts.length > 5;\n    }\n    \n    analyzePatterns() {\n      // Deep analysis of patterns\n      this.playerBehaviorPatterns = this.extractBehaviorPatterns();\n    }\n    \n    extractBehaviorPatterns() {\n      return this.chaseAttempts.map(attempt => ({\n        location: attempt.playerLocation,\n        action: attempt.playerAction,\n        escaped: attempt.succeededEscape\n      }));\n    }\n    \n    predictPlayerBehavior(gameState) {\n      const patterns = this.playerBehaviorPatterns;\n      if (patterns.length === 0) return null;\n      \n      // Find similar situations\n      const similarities = patterns.filter(p => \n        p.location.x === gameState.player.position.x\n      );\n      \n      return {\n        predictedLocation: similarities[0]?.location || null,\n        likelyHidingSpot: this.getMostLikelyHideSpot(),\n        confidence: Math.min(similarities.length / patterns.length, 1)\n      };\n    }\n    \n    getMostLikelyHideSpot() {\n      // Return most frequently used hide spot\n      return null;\n    }\n    \n    getTopPatterns(count) {\n      return this.playerBehaviorPatterns.slice(0, count);\n    }\n  }\n\n  /**\n   * Psychology Engine - Analyzes and uses psychology\n   */\n  class PsychologyEngine {\n    constructor() {\n      this.fearObservations = [];\n      this.playerWeaknesses = [];\n      this.psychologicalVulnerabilities = [];\n    }\n    \n    recordFearDetected(fearLevel) {\n      this.fearObservations.push({\n        level: fearLevel,\n        timestamp: Date.now()\n      });\n    }\n    \n    analyzeFearPatterns() {\n      // Identify what triggers player fear\n      return this.fearObservations.map(o => o.level).reduce((a, b) => a + b, 0) / this.fearObservations.length;\n    }\n  }\n\n  // Helper methods\n  moveTowards(target) {\n    const direction = {\n      x: target.x - this.position.x,\n      y: target.y - this.position.y,\n      z: target.z - this.position.z\n    };\n    \n    const distance = Math.sqrt(direction.x ** 2 + direction.y ** 2 + direction.z ** 2);\n    const speed = 0.5; // Units per frame\n    \n    if (distance > 0) {\n      this.position.x += (direction.x / distance) * speed;\n      this.position.y += (direction.y / distance) * speed;\n      this.position.z += (direction.z / distance) * speed;\n    }\n  }\n\n  moveToNextHuntingArea() {\n    // Intelligent patrol\n  }\n\n  listenForSounds() {\n    // Listen for player sounds\n  }\n\n  randomSearchPattern() {\n    // Search randomly\n  }\n\n  setTrap(location) {\n    this.logger.log('K\\'Thaal sets trap at', location);\n  }\n\n  cornerPlayer(gameState) {\n    this.logger.log('K\\'Thaal corners player - no escape!');\n  }\n\n  async taunt(gameState) {\n    this.logger.log('K\\'Thaal: \"You cannot hide forever...\"');\n  }\n\n  async offerDeal(gameState) {\n    this.logger.log('K\\'Thaal offers dark partnership...');\n  }\n\n  letPlayerEscape(gameState) {\n    this.logger.log('K\\'Thaal lets player escape... for now');\n  }\n\n  onSoundDetected(soundEvent) {\n    this.awarenessLevel += soundEvent.intensity * 25;\n  }\n}\n\nif (typeof module !== 'undefined' && module.exports) {\n  module.exports = { AlienKillerAI_v2 };\n}\n